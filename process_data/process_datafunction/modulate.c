#include <stdio.h>
#include <stdlib.h>
#include "../../headers/process_data.h"
#include "../../headers/commonStructure.h"
#include "../../headers/globalVarINIT.h"

/*
complex32 QAM1[2] = {{-8192,0},{8192,0}};

complex32 QAM2[4] = { { -5793,5793 },{ 5793,5793 },\
                    { -5793,-5793 },{ 5793,-5793 },};

complex32 QAM4[16] = { { -7772,7772 },{ -2591,7772 },{ 2591,7772 },{ 7772,7772 },\
                     { -7772,2591 },{ -2591,2591 },{ 2591,2591 },{ 7772,2591 },\
                     { -7772,-2591 },{ -2591,-2591 },{ 2591,-2591 },{ 7772,-2591 },\
                     { -7772,-7772 },{ -2591,-7772 },{ 2591,-7772 },{ 7772,-7772 },};

complex32 QAM8[64] = { { -8848,8848 },{ -6320,8848 },{ -3792,8848 },{ -1264,8848 },{ 1264,8848 },{ 3792,8848 },{ 6320,8848 },{ 8848,8848 },\
                     { -8848,6320 },{ -6320,6320 },{ -3792,6320 },{ -1264,6320 },{ 1264,6320 },{ 3792,6320 },{ 6320,6320 },{ 8848,6320 },\
                     { -8848,3792 },{ -6320,3792 },{ -3792,3792 },{ -1264,3792 },{ 1264,3792 },{ 3792,3792 },{ 6320,3792 },{ 8848,3792 },\
                     { -8848,1264 },{ -6320,1264 },{ -3792,1264 },{ -1264,1264 },{ 1264,1264 },{ 3792,1264 },{ 6320,1264 },{ 8848,1264 },\
                     { -8848,-1264 },{ -6320,-1264 },{ -3792,-1264 },{ -1264,-1264 },{ 1264,-1264 },{ 3792,-1264 },{ 6320,-1264 },{ 8848,-1264 },\
                     { -8848,-3792 },{ -6320,-3792 },{ -3792,-3792 },{ -1264,-3792 },{ 1264,-3792 },{ 3792,-3792 },{ 6320,-3792 },{ 8848,-3792 },\
                     { -8848,-6320 },{ -6320,-6320 },{ -3792,-6320 },{ -1264,-6320 },{ 1264,-6320 },{ 3792,-6320 },{ 6320,-6320 },{ 8848,-6320 },\
                     { -8848,-8848 },{ -6320,-8848 },{ -3792,-8848 },{ -1264,-8848 },{ 1264,-8848 },{ 3792,-8848 },{ 6320,-8848 },{ 8848,-8848 },};

complex32 QAM16[256] = { { -9424,9424 },{ -8168,9424 },{ -6911,9424 },{ -5655,9424 },{ -4398,9424 },{ -3141,9424 },{ -1885,9424 },{ -628,9424 },{ 628,9424 },{ 1885,9424 },{ 3141,9424 },{ 4398,9424 },{ 5655,9424 },{ 6911,9424 },{ 8168,9424 },{ 9424,9424 },\
                     { -9424,8168 },{ -8168,8168 },{ -6911,8168 },{ -5655,8168 },{ -4398,8168 },{ -3141,8168 },{ -1885,8168 },{ -628,8168 },{ 628,8168 },{ 1885,8168 },{ 3141,8168 },{ 4398,8168 },{ 5655,8168 },{ 6911,8168 },{ 8168,8168 },{ 9424,8168 },\
                     { -9424,6911 },{ -8168,6911 },{ -6911,6911 },{ -5655,6911 },{ -4398,6911 },{ -3141,6911 },{ -1885,6911 },{ -628,6911 },{ 628,6911 },{ 1885,6911 },{ 3141,6911 },{ 4398,6911 },{ 5655,6911 },{ 6911,6911 },{ 8168,6911 },{ 9424,6911 },\
                     { -9424,5655 },{ -8168,5655 },{ -6911,5655 },{ -5655,5655 },{ -4398,5655 },{ -3141,5655 },{ -1885,5655 },{ -628,5655 },{ 628,5655 },{ 1885,5655 },{ 3141,5655 },{ 4398,5655 },{ 5655,5655 },{ 6911,5655 },{ 8168,5655 },{ 9424,5655 },\
                     { -9424,4398 },{ -8168,4398 },{ -6911,4398 },{ -5655,4398 },{ -4398,4398 },{ -3141,4398 },{ -1885,4398 },{ -628,4398 },{ 628,4398 },{ 1885,4398 },{ 3141,4398 },{ 4398,4398 },{ 5655,4398 },{ 6911,4398 },{ 8168,4398 },{ 9424,4398 },\
                     { -9424,3141 },{ -8168,3141 },{ -6911,3141 },{ -5655,3141 },{ -4398,3141 },{ -3141,3141 },{ -1885,3141 },{ -628,3141 },{ 628,3141 },{ 1885,3141 },{ 3141,3141 },{ 4398,3141 },{ 5655,3141 },{ 6911,3141 },{ 8168,3141 },{ 9424,3141 },\
                     { -9424,1885 },{ -8168,1885 },{ -6911,1885 },{ -5655,1885 },{ -4398,1885 },{ -3141,1885 },{ -1885,1885 },{ -628,1885 },{ 628,1885 },{ 1885,1885 },{ 3141,1885 },{ 4398,1885 },{ 5655,1885 },{ 6911,1885 },{ 8168,1885 },{ 9424,1885 },\
                     { -9424,628 },{ -8168,628 },{ -6911,628 },{ -5655,628 },{ -4398,628 },{ -3141,628 },{ -1885,628 },{ -628,628 },{ 628,628 },{ 1885,628 },{ 3141,628 },{ 4398,628 },{ 5655,628 },{ 6911,628 },{ 8168,628 },{ 9424,628 },\
                     { -9424,-628 },{ -8168,-628 },{ -6911,-628 },{ -5655,-628 },{ -4398,-628 },{ -3141,-628 },{ -1885,-628 },{ -628,-628 },{ 628,-628 },{ 1885,-628 },{ 3141,-628 },{ 4398,-628 },{ 5655,-628 },{ 6911,-628 },{ 8168,-628 },{ 9424,-628 },\
                     { -9424,-1885 },{ -8168,-1885 },{ -6911,-1885 },{ -5655,-1885 },{ -4398,-1885 },{ -3141,-1885 },{ -1885,-1885 },{ -628,-1885 },{ 628,-1885 },{ 1885,-1885 },{ 3141,-1885 },{ 4398,-1885 },{ 5655,-1885 },{ 6911,-1885 },{ 8168,-1885 },{ 9424,-1885 },\
                     { -9424,-3141 },{ -8168,-3141 },{ -6911,-3141 },{ -5655,-3141 },{ -4398,-3141 },{ -3141,-3141 },{ -1885,-3141 },{ -628,-3141 },{ 628,-3141 },{ 1885,-3141 },{ 3141,-3141 },{ 4398,-3141 },{ 5655,-3141 },{ 6911,-3141 },{ 8168,-3141 },{ 9424,-3141 },\
                     { -9424,-4398 },{ -8168,-4398 },{ -6911,-4398 },{ -5655,-4398 },{ -4398,-4398 },{ -3141,-4398 },{ -1885,-4398 },{ -628,-4398 },{ 628,-4398 },{ 1885,-4398 },{ 3141,-4398 },{ 4398,-4398 },{ 5655,-4398 },{ 6911,-4398 },{ 8168,-4398 },{ 9424,-4398 },\
                     { -9424,-5655 },{ -8168,-5655 },{ -6911,-5655 },{ -5655,-5655 },{ -4398,-5655 },{ -3141,-5655 },{ -1885,-5655 },{ -628,-5655 },{ 628,-5655 },{ 1885,-5655 },{ 3141,-5655 },{ 4398,-5655 },{ 5655,-5655 },{ 6911,-5655 },{ 8168,-5655 },{ 9424,-5655 },\
                     { -9424,-6911 },{ -8168,-6911 },{ -6911,-6911 },{ -5655,-6911 },{ -4398,-6911 },{ -3141,-6911 },{ -1885,-6911 },{ -628,-6911 },{ 628,-6911 },{ 1885,-6911 },{ 3141,-6911 },{ 4398,-6911 },{ 5655,-6911 },{ 6911,-6911 },{ 8168,-6911 },{ 9424,-6911 },\
                     { -9424,-8168 },{ -8168,-8168 },{ -6911,-8168 },{ -5655,-8168 },{ -4398,-8168 },{ -3141,-8168 },{ -1885,-8168 },{ -628,-8168 },{ 628,-8168 },{ 1885,-8168 },{ 3141,-8168 },{ 4398,-8168 },{ 5655,-8168 },{ 6911,-8168 },{ 8168,-8168 },{ 9424,-8168 },\
                     { -9424,-9424 },{ -8168,-9424 },{ -6911,-9424 },{ -5655,-9424 },{ -4398,-9424 },{ -3141,-9424 },{ -1885,-9424 },{ -628,-9424 },{ 628,-9424 },{ 1885,-9424 },{ 3141,-9424 },{ 4398,-9424 },{ 5655,-9424 },{ 6911,-9424 },{ 8168,-9424 },{ 9424,-9424 },};
*/

void bi2de(unsigned char **code_out, int BCC_length, int mode );
void Modulation_11ax(unsigned char **code_out, int *NumSampEffect, int mode, complex32 **sym_mod);

void modulate(unsigned char **code_out ,int BCC_length , int N_SYM, complex32 **sym_mod, int *NumSampEffect)
{
    unsigned char rate_type;
    int N_BPSCS, N_DBPS, N_CBPS, N_ES;
    int mode;
    mcs_table_for_20M(&rate_type, &N_BPSCS, &N_DBPS, &N_CBPS, &N_ES);
    mode = N_BPSCS/2;
    *NumSampEffect = N_CBPS*N_SYM/N_STS/N_BPSCS;

    if(BCC_length!=N_BPSCS*(*NumSampEffect))      //BCC_length wrong!
    {
        printf("error: BCC_out size wrong!");
        exit(1);
    }

    if(mode == 0)
    {
        printf("sorry: mode = 0, we haven't done this.");
        exit(0);
    }

    bi2de(code_out, BCC_length, mode);  //将二进制转化为十进制

    Modulation_11ax(code_out, NumSampEffect, mode, sym_mod);
}

void bi2de(unsigned char **code_out, int BCC_length, int mode )
{
    int num = BCC_length/mode;
    int i,j,k;
    int out;

    for(i=1;i<=N_STS;i++)
    {
        for(j=1;j<=num;j++)
        {
            out = 0;
            for(k=1;k<=mode;k++)
            {
                if(code_out[i-1][mode*(j-1)+(k-1)] == 1)
                    out = out + twice(mode-k);
                else
                    out = out + 0;
            }
            code_out[i-1][j-1] = out;
        }
    }
}

void Modulation_11ax(unsigned char **code_out, int *NumSampEffect, int mode, complex32 **sym_mod)
{
    int index[16] = {1,2,4,3,8,7,5,6,16,15,13,14,9,10,12,11};
    int i,j,real_j,imag_j,k;
    //int N = (*NumSampEffect)/2;
    complex32 *C;
    switch(mode)
    {
        case 0: C=QAM1;
                break;

        case 1: C=QAM2;
                break;

        case 2: C=QAM4;
                break;

        case 3: C=QAM8;
                break;

        case 4: C=QAM16;
                break;

        default: printf("error: value of mode is wrong!");
                 exit(1);
    }
    for(i=1;i<=N_STS;i++)
    {
        for(j=1;j<=*NumSampEffect;j++)
        {
            real_j = index[code_out[i-1][2*j-2]];
            imag_j = index[code_out[i-1][2*j-1]];
            k = (twice(mode)-imag_j)*twice(mode)+real_j;
            sym_mod[i-1][j-1] = C[k-1];
        }
    }

}
